<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>5.6.1. Requirements for an asynchronous interface compatible with python 3 asyncio &#8212; pyrpl 0.9.7.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css?v=4468db6d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <script src="../../../_static/documentation_options.js?v=cf93a8f2"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../_static/icon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="5.6.2. Asynchronous sleep function and benchmarks" href="benchmark.html" />
    <link rel="prev" title="5.6. API specifications from the moment of their development" href="../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>

  </head><body>
  

  <style id="ribbon">
    #forkongithub a{background:#c11;color:#fff;text-decoration:none;font-family:arial,sans-serif;text-align:center;font-weight:bold;padding:5px 40px;font-size:1rem;line-height:2rem;position:relative;transition:0.5s;}
    #forkongithub a:hover{background:#1c1;color:#fff;}
    #forkongithub a::before,
    #forkongithub a::after{content:"";width:100%;display:block;position:absolute;top:1px;left:0;height:1px;background:#fff;}
    #forkongithub a::after{bottom:1px;top:auto;}@media screen and (min-width:800px)
    { #forkongithub{position:fixed;display:block;top:0;right:0;width:200px;overflow:hidden;height:200px;z-index:9999;}#forkongithub a{width:200px;position:absolute;top:45px;right:-45px;transform:rotate(45deg);-webkit-transform:rotate(45deg);-ms-transform:rotate(45deg);-moz-transform:rotate(45deg);-o-transform:rotate(45deg);box-shadow:4px 4px 10px rgba(0,0,0,0.8);}}
  </style>
  <span id="forkongithub"><a href="https://www.github.com/lneuhaus/pyrpl#fork-destination-box">Fork PyRPL on GitHub</a></span>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-102689373-2', 'auto');
    ga('send', 'pageview');

  </script>


  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          PyRPL</a>
        <span class="navbar-text navbar-version pull-left"><b>0.9.7.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../index.html">Home</a></li>
                <li><a href="../../../installation.html">Installation</a></li>
                <li><a href="../../../gui.html">Graphical user interface</a></li>
                <li><a href="../../../api.html">API</a></li>
                <li><a href="../../../basics.html">How PyRPL works</a></li>
                <li><a href="../../index.html">Infos for Developers</a></li>
            
            
              
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">5.6.1. Requirements for an asynchronous interface compatible with python 3 asyncio</a><ul>
<li><a class="reference internal" href="#asynchronous-programming-in-python-3">5.6.1.1. asynchronous programming in python 3</a></li>
<li><a class="reference internal" href="#can-we-make-that-compatible-with-python-2">5.6.1.2. Can we make that compatible with python 2</a></li>
<li><a class="reference internal" href="#asynchronous-sleep-function-benchmarks">5.6.1.3. Asynchronous sleep function benchmarks</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <section id="requirements-for-an-asynchronous-interface-compatible-with-python-3-asyncio">
<h1><span class="section-number">5.6.1. </span>Requirements for an asynchronous interface compatible with python 3 asyncio<a class="headerlink" href="#requirements-for-an-asynchronous-interface-compatible-with-python-3-asyncio" title="Link to this heading">¶</a></h1>
<section id="asynchronous-programming-in-python-3">
<h2><span class="section-number">5.6.1.1. </span>asynchronous programming in python 3<a class="headerlink" href="#asynchronous-programming-in-python-3" title="Link to this heading">¶</a></h2>
<p>The idea behind async programming in python 3 is to avoid callbacks
because they make the code difficult to read. Instead, they are replaced
by “coroutines”: a coroutine is a function that is declared with the
<code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code> keyword. Its execution can be stopped and restarted upon
request at each <code class="docutils literal notranslate"><span class="pre">await</span></code> statement. This allows not to break loops into
several chained timer/signal/slot mechanisms and makes the code much
more readable (actually, very close to the corresponding synchronous
function). Let’s see that on an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">pylab</span> <span class="n">qt</span> <span class="c1"># in a notebook, we need the qt event loop to run in the background</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.fftpack</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qasync</span> <span class="c1"># qasync allows to use the asyncio syntax of python 3 with the Qt event loop. Not sure how mainstream the library is...</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt4</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">qasync</span><span class="o">.</span><span class="n">QEventLoop</span><span class="p">()</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span> <span class="c1"># set the qt event loop as the loop to be used by asyncio</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Scope</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg</span><span class="p">):</span>
        <span class="n">y_avg</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">avg</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y_avg</span><span class="o">+=</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_avg</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SpecAn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">Scope</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">avg</span><span class="p">):</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">run_single</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span><span class="o">+=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">fftpack</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

<span class="n">sa</span> <span class="o">=</span> <span class="n">SpecAn</span><span class="p">()</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">run_single</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="c1"># to send a coroutine to the asyncio event loop, use ensure_future, and get a future...</span>

<span class="n">v</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="c1"># raise InvalidStateError until result is ready, then returns the averaged curve</span>
</pre></div>
</div>
<p>Wonderful !! As a comparison, the same code written with QTimers (in
practice, the code execution is probably extremely similar)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">pylab</span> <span class="n">qt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.fftpack</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qasync</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt4</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>
<span class="n">APP</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">promise</span><span class="w"> </span><span class="kn">import</span> <span class="n">Promise</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">qasync</span><span class="o">.</span><span class="n">QEventLoop</span><span class="p">()</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyPromise</span><span class="p">(</span><span class="n">Promise</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_pending</span><span class="p">:</span>
            <span class="n">APP</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyPromise</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Scope</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">setSingleShot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_for_curve</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="n">avg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_avg</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">MyPromise</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_for_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_avg</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">avg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_avg</span> <span class="o">+=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_avg</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">fulfill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_avg</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SpecAn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">Scope</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">setSingleShot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="n">avg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_avg</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">run_single</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_one_curve</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">MyPromise</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">average_one_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;av&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_avg</span><span class="o">+=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_avg</span><span class="o">+=</span><span class="n">scipy</span><span class="o">.</span><span class="n">fftpack</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_avg</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">avg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">fulfill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_avg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">run_single</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_one_curve</span><span class="p">)</span>

<span class="n">sa</span> <span class="o">=</span> <span class="n">SpecAn</span><span class="p">()</span>
</pre></div>
</div>
<p>… I dont blame you if you do not want to read the example above
because its so lengthy! The loop variables have to be passed across
functions via instance attributes, there’s no way of clearly visualizing
the execution flow. This is terrible to read and this pretty much what
we have to live with in the asynchronous part of pyrpl if we want pyrpl
to be compatible with python 2 (this is now more or less confined in
AcquisitionManager now).</p>
</section>
<section id="can-we-make-that-compatible-with-python-2">
<h2><span class="section-number">5.6.1.2. </span>Can we make that compatible with python 2<a class="headerlink" href="#can-we-make-that-compatible-with-python-2" title="Link to this heading">¶</a></h2>
<p>The feature presented here is only compatible with python 3.5+ (by
changing slightly the syntax, we could make it work on python 3.4). On
the other hand, for python 2: the only backport is the library trollius,
but it is not under development anymore, also, I am not sure if the
syntax is exactly identical).</p>
<p>In other words, if we want to stay python 2 compatible, we cannot use
the syntactic sugar of coroutines in the pyrpl code, we have to stick to
the spaghetti-like callback mess. However, I would like to make the
asynchronous parts of pyrpl fully compatible (from the user point of
view) with the asyncio mechanism. This way, users of python 3 will be
able to use functions such as run_single as coroutines and write
beautiful code with it (eventhough the inside of the function looks like
spaghetti code due to the constraint of being python 2 compatible).</p>
<p>To make specifications a bit clearer, let’s see an example of what a
python 3 user should be allowed to do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">my_coroutine</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;launching f&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">run_single</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;launching g&quot;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">na</span><span class="o">.</span><span class="n">run_single</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=======&quot;</span><span class="p">)</span>
        <span class="n">c1</span><span class="o">+=</span> <span class="k">await</span> <span class="n">f</span>
        <span class="n">c2</span><span class="o">+=</span> <span class="k">await</span> <span class="n">g</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f returned&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;g returned&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">my_coroutine</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>In this example, the user wants to ask <em>simultaneously</em> the na and the
scope for a single curve, and when both curves are ready, do something
with them and move to the next iteration. The following python 3 classes
would easily do the trick:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">pylab</span> <span class="n">qt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.fftpack</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qasync</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt4</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">qasync</span><span class="o">.</span><span class="n">QEventLoop</span><span class="p">()</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Scope</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg</span><span class="p">):</span>
        <span class="n">y_avg</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">avg</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y_avg</span><span class="o">+=</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_avg</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Na</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg</span><span class="p">):</span>
        <span class="n">y_avg</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">avg</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y_avg</span><span class="o">+=</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_avg</span>

<span class="n">scope</span> <span class="o">=</span> <span class="n">Scope</span><span class="p">()</span>
<span class="n">na</span> <span class="o">=</span> <span class="n">Na</span><span class="p">()</span>
</pre></div>
</div>
<p>What I would like is to find a way to make the same happen without
writing any line of code in pyrpl that is not valid python 2.7…
Actually, it seems the following code does the trick:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span><span class="p">,</span> <span class="n">ensure_future</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyFuture</span><span class="p">(</span><span class="n">Future</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyFuture</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">setSingleShot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_exit_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEventLoop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exit_loop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyFuture</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AsyncScope</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">MyFuture</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">AsyncScope</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="asynchronous-sleep-function-benchmarks">
<h2><span class="section-number">5.6.1.3. </span>Asynchronous sleep function benchmarks<a class="headerlink" href="#asynchronous-sleep-function-benchmarks" title="Link to this heading">¶</a></h2>
<p>This is contained in <a class="reference internal" href="benchmark.html"><span class="doc">Asynchronous sleep function and benchmarks</span></a>.</p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../../_sources/developer_guide/api/asynchronous/index.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2014-2025, Leonhard Neuhaus, Samuel Deléglise, Michaël Croquette .<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.4.7.<br/>
    </p>
  </div>
</footer>
  </body>
</html>
<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Introduction to pyrpl &#8212; pyrpl 0.9.7.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css?v=4468db6d" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <script src="../../_static/documentation_options.js?v=cf93a8f2"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="../../_static/icon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body>
  

  <style id="ribbon">
    #forkongithub a{background:#c11;color:#fff;text-decoration:none;font-family:arial,sans-serif;text-align:center;font-weight:bold;padding:5px 40px;font-size:1rem;line-height:2rem;position:relative;transition:0.5s;}
    #forkongithub a:hover{background:#1c1;color:#fff;}
    #forkongithub a::before,
    #forkongithub a::after{content:"";width:100%;display:block;position:absolute;top:1px;left:0;height:1px;background:#fff;}
    #forkongithub a::after{bottom:1px;top:auto;}@media screen and (min-width:800px)
    { #forkongithub{position:fixed;display:block;top:0;right:0;width:200px;overflow:hidden;height:200px;z-index:9999;}#forkongithub a{width:200px;position:absolute;top:45px;right:-45px;transform:rotate(45deg);-webkit-transform:rotate(45deg);-ms-transform:rotate(45deg);-moz-transform:rotate(45deg);-o-transform:rotate(45deg);box-shadow:4px 4px 10px rgba(0,0,0,0.8);}}
  </style>
  <span id="forkongithub"><a href="https://www.github.com/lneuhaus/pyrpl#fork-destination-box">Fork PyRPL on GitHub</a></span>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-102689373-2', 'auto');
    ga('send', 'pageview');

  </script>


  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          PyRPL</a>
        <span class="navbar-text navbar-version pull-left"><b>0.9.7.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../installation.html">Installation</a></li>
                <li><a href="../../gui.html">Graphical user interface</a></li>
                <li><a href="../../api.html">API</a></li>
                <li><a href="../../basics.html">How PyRPL works</a></li>
                <li><a href="../../developer_guide/index.html">Infos for Developers</a></li>
            
            
              
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Introduction to pyrpl</a><ul>
<li><a class="reference internal" href="#introduction">1) Introduction</a></li>
</ul>
</li>
<li><a class="reference internal" href="#table-of-contents">2) Table of contents</a></li>
<li><a class="reference internal" href="#installation">3) Installation</a><ul>
<li><a class="reference internal" href="#first-steps">4) First steps</a><ul>
<li><a class="reference internal" href="#connecting-to-the-redpitaya">Connecting to the RedPitaya</a></li>
<li><a class="reference internal" href="#basic-communication-with-your-redpitaya">Basic communication with your RedPitaya</a></li>
</ul>
</li>
<li><a class="reference internal" href="#redpitaya-modules">5) RedPitaya modules</a><ul>
<li><a class="reference internal" href="#asg-and-scope-module">ASG and Scope module</a></li>
<li><a class="reference internal" href="#arbitrary-signal-generator">Arbitrary Signal Generator</a></li>
<li><a class="reference internal" href="#oscilloscope">Oscilloscope</a></li>
<li><a class="reference internal" href="#pid-module">PID module</a><ul>
<li><a class="reference internal" href="#proportional-and-integral-gain">Proportional and integral gain</a></li>
<li><a class="reference internal" href="#control-with-the-integral-value-register">Control with the integral value register</a></li>
<li><a class="reference internal" href="#input-filters">Input filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iq-module">IQ module</a><ul>
<li><a class="reference internal" href="#network-analyzer">Network analyzer</a></li>
<li><a class="reference internal" href="#lorentzian-bandpass-filter">Lorentzian bandpass filter</a></li>
<li><a class="reference internal" href="#frequency-comparator-module">Frequency comparator module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iir-module">IIR module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-pyrpl-class">6) The Pyrpl class</a><ul>
<li><a class="reference internal" href="#first-attempts-at-locking">First attempts at locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-graphical-user-interface">7) The Graphical User Interface</a></li>
<li><a class="reference internal" href="#using-asynchronous-functions-with-python-3">8) Using asynchronous functions with python 3</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <section id="introduction-to-pyrpl">
<h1>Introduction to pyrpl<a class="headerlink" href="#introduction-to-pyrpl" title="Link to this heading">¶</a></h1>
<section id="introduction">
<h2>1) Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>The RedPitaya is an affordable FPGA board with fast analog inputs and
outputs. This makes it interesting also for quantum optics experiments.
The software package PyRPL (Python RedPitaya Lockbox) is an
implementation of many devices that are needed for optics experiments
every day. The user interface and all high-level functionality is
written in python, but an essential part of the software is hidden in a
custom FPGA design (based on the official RedPitaya software version
0.95). While most users probably never want to touch the FPGA design,
the Verilog source code is provided together with this package and may
be modified to customize the software to your needs.</p>
</section>
</section>
<section id="table-of-contents">
<h1>2) Table of contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">¶</a></h1>
<p>In this document, you will find the following sections: 1. Introduction
2. ToC 3. Installation 4. First steps 5. RedPitaya Modules 6. The Pyrpl
class 7. The Graphical User Interface</p>
<p>If you are using Pyrpl for the first time, you should read sections 1-4.
This will take about 15 minutes and should leave you able to communicate
with your RedPitaya via python.</p>
<p>If you plan to use Pyrpl for a project that is not related to quantum
optics, you probably want to go to section 5 then and omit section 6
altogether. Inversely, if you are only interested in a powerful tool for
quantum optics and dont care about the details of the implementation, go
to section 6. If you plan to contribute to the repository, you should
definitely read section 5 to get an idea of what this software package
realy does, and where help is needed. Finaly, Pyrpl also comes with a
Graphical User Interface (GUI) to interactively control the modules
described in section 5. Please, read section 7 for a quick description
of the GUI.</p>
</section>
<section id="installation">
<h1>3) Installation<a class="headerlink" href="#installation" title="Link to this heading">¶</a></h1>
<p>If instead you plan to synchronize with github on a regular basis, you
can also leave the downloaded code where it is and add the parent
directory of the pyrpl folder to the PYTHONPATH environment variable as
described in this thread:
<a class="reference external" href="http://stackoverflow.com/questions/3402168/permanently-add-a-directory-to-pythonpath">http://stackoverflow.com/questions/3402168/permanently-add-a-directory-to-pythonpath</a>.
For all beta-testers and developers, this is the preferred option. So
the typical PYTHONPATH environment variable should look somewhat like
this: <span class="math notranslate nohighlight">\(\texttt{PYTHONPATH=C:\OTHER_MODULE;C:\GITHUB\PYRPL}\)</span></p>
<p>If you are experiencing problems with the dependencies on other python
packages, executing the following command in the pyrpl directory might
help:</p>
<p><span class="math notranslate nohighlight">\(\texttt{python setup.py install develop}\)</span></p>
<p>If at a later point, you have the impression that updates from github
are not reflected in the program’s behavior, try this:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyrpl</span>
<span class="nb">print</span> <span class="n">pyrpl</span><span class="o">.</span><span class="vm">__file__</span>
</pre></div>
</div>
<p>Should the directory not be the one of your local github installation,
you might have an older version of pyrpl installed. Just delete any such
directories other than your principal github clone and everything should
work.</p>
<p>Download the code manually from
<a class="reference external" href="https://github.com/lneuhaus/pyrpl/archive/master.zip">https://github.com/lneuhaus/pyrpl/archive/master.zip</a> and unzip it or get
it directly from git by typing</p>
<p><span class="math notranslate nohighlight">\(\texttt{git clone https://github.com/lneuhaus/pyrpl.git YOUR_DESTINATIONFOLDER}\)</span></p>
<p>In a command line shell, navigate into your new local pyrplockbox
directory and execute</p>
<p><span class="math notranslate nohighlight">\(\texttt{python setup.py install}\)</span></p>
<p>This copies the files into the side-package directory of python. The
setup should make sure that you have the python libraries paramiko
(<a class="reference external" href="http://www.paramiko.org/installing.html">http://www.paramiko.org/installing.html</a>) and scp
(<a class="reference external" href="https://pypi.python.org/pypi/scp">https://pypi.python.org/pypi/scp</a>) installed. If this is not the case
you will get a corresponding error message in a later step of this
tutorial.</p>
<p>If you have pip correctly installed, executing the following line in a
command line should install pyrplockbox and all dependencies:</p>
<p><span class="math notranslate nohighlight">\(\texttt{pip install pyrpl}\)</span></p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pyrpl<span class="w"> </span>#if<span class="w"> </span>you<span class="w"> </span>look<span class="w"> </span>at<span class="w"> </span>this<span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span>ipython<span class="w"> </span>notebook,<span class="w"> </span>just<span class="w"> </span>execute<span class="w"> </span>this<span class="w"> </span>cell<span class="w"> </span>to<span class="w"> </span>install<span class="w"> </span>pyrplockbox
</pre></div>
</div>
<p>The software comes with a precompiled version of the server application
(written in C) that runs on the RedPitaya. This application is uploaded
automatically when you start the connection. If you made changes to this
file, you can recompile it by typing</p>
<p><span class="math notranslate nohighlight">\(\texttt{python setup.py compile_server}\)</span></p>
<p>For this to work, you must have gcc and the cross-compiling libraries
installed. Basically, if you can compile any of the official RedPitaya
software written in C, then this should work, too. If you do not have a
working cross-compiler installed on your UserPC, you can also compile
directly on the RedPitaya (tested with ecosystem v0.95). To do so, you
must upload the directory pyrpl/monitor_server on the redpitaya, and
launch the compilation with the command
<span class="math notranslate nohighlight">\(\texttt{make CROSS_COMPILE=}\)</span></p>
<p>If you would like to modify the FPGA code or just make sure that it can
be compiled, you should have a working installation of Vivado 2015.4.
For windows users it is recommended to set up a virtual machine with
Ubuntu on which the compiler can be run in order to avoid any
compatibility problems. For the FPGA part, you only need the /fpga
subdirectory of this software. Make sure it is somewhere in the file
system of the machine with the vivado installation. Then type the
following commands. You should adapt the path in the first and second
commands to the locations of the Vivado installation / the fpga
directory in your filesystem:</p>
<p><span class="math notranslate nohighlight">\(\texttt{source /opt/Xilinx/Vivado/2015.4/settings64.sh}\)</span></p>
<p><span class="math notranslate nohighlight">\(\texttt{cd /home/myusername/fpga}\)</span></p>
<p><span class="math notranslate nohighlight">\(\texttt{make}\)</span></p>
<p>The compilation should take between 15 and 30 minutes. The result will
be the file <span class="math notranslate nohighlight">\(\texttt{fpga/red_pitaya.bin}\)</span>. To test the new FPGA
design, make sure that this file in the fpga subdirectory of your pyrpl
code directory. That is, if you used a virtual machine for the
compilation, you must copy the file back to the original machine on
which you run pyrpl.</p>
<p>In order to make sure that any recent changes do not affect prior
functionality, a large number of automated tests have been implemented.
Every push to the github repository is automatically installed tested on
an empty virtual linux system. However, the testing server has currently
no RedPitaya available to run tests directly on the FPGA. Therefore it
is also useful to run these tests on your local machine in case you
modified the code.</p>
<p>Currently, the tests confirm that - all pyrpl modules can be loaded in
python - all designated registers can be read and written - future:
functionality of all major submodules against reference benchmarks</p>
<p>To run the test, navigate in command line into the pyrpl directory and
type</p>
<p><span class="math notranslate nohighlight">\(\texttt{set REDPITAYA=192.168.1.100}\)</span> (in windows) or</p>
<p><span class="math notranslate nohighlight">\(\texttt{export REDPITAYA=192.168.1.100}\)</span> (in linux)</p>
<p><span class="math notranslate nohighlight">\(\texttt{python setup.py nosetests}\)</span></p>
<p>The first command tells the test at which IP address it can find a
RedPitaya. The last command runs the actual test. After a few seconds,
there should be some output saying that the software has passed more
than 140 tests.</p>
<p>After you have implemented additional features, you are encouraged to
add unitary tests to consolidate the changes. If you immediately
validate your changes with unitary tests, this will result in a huge
productivity improvement for you. You can find all test files in the
folder <span class="math notranslate nohighlight">\(\texttt{pyrpl/pyrpl/test}\)</span>, and the existing examples
(notably <span class="math notranslate nohighlight">\(\texttt{test_example.py}\)</span>) should give you a good point
to start. As long as you add a function starting with ‘test_’ in one of
these files, your test should automatically run along with the others.
As you add more tests, you will see the number of total tests increase
when you run the test launcher.</p>
<p>As soon as the code will have reached version 0.9.0.3 (high-level
unitary tests implemented and passing, approx. end of May 2016), we will
consider the master branch of the github repository as the stable
pre-release version. The goal is that the master branch will guarantee
functionality at all times.</p>
<p>Any changes to the code, if they do not pass the unitary tests or have
not been tested, are to be submitted as pull-requests in order not to
endanger the stability of the master branch. We will briefly desribe how
to properly submit your changes in that scenario.</p>
<p>Let’s say you already changed the code of your local clone of pyrpl.
Instead of directly committing the change to the master branch, you
should create your own branch. In the windows application of github,
when you are looking at the pyrpl repository, there is a small symbol
looking like a steet bifurcation in the upper left corner, that says
“Create new branch” when you hold the cursor over it. Click it and enter
the name of your branch “leos development branch” or similar. The
program will automatically switch to that branch. Now you can commit
your changes, and then hit the “publish” or “sync” button in the upper
right. That will upload your changes so everyone can see and test them.</p>
<p>You can continue working on your branch, add more commits and sync them
with the online repository until your change is working. If the master
branch has changed in the meantime, just click ‘sync’ to download them,
and then the button “update from master” (upper left corner of the
window) that will insert the most recent changes of the master branch
into your branch. If the button doesn’t work, that means that there are
no changes available. This way you can benefit from the updates of the
stable pre-release version, as long as they don’t conflict with the
changes you have been working on. If there are conflicts, github will
wait for you to resolve them. In case you have been recompiling the
fpga, there will always be a conflict w.r.t. the file ‘red_pitaya.bin’
(since it is a binary file, github cannot simply merge the differences
you implemented). The best way to deal with this problem is to recompile
the fpga bitfile after the ‘update from master’. This way the binary
file in your repository will correspond to the fpga code of the merged
verilog files, and github will understand from the most recent
modification date of the file that your local version of red_pitaya.bin
is the one to keep.</p>
<p>At some point, you might want to insert your changes into the master
branch, because they have been well-tested and are going to be useful
for everyone else, too. To do so, after having committed and synced all
recent changes to your branch, click on “Pull request” in the upper
right corner, enter a title and description concerning the changes you
have made, and click “Send pull request”. Now your job is done. I will
review and test the modifications of your code once again, possibly fix
incompatibility issues, and merge it into the master branch once all is
well. After the merge, you can delete your development branch. If you
plan to continue working on related changes, you can also keep the
branch and send pull requests later on. If you plan to work on a
different feature, I recommend you create a new branch with a name
related to the new feature, since this will make the evolution history
of the feature more understandable for others. Or, if you would like to
go back to following the master branch, click on the little downward
arrow besides the name of your branch close to the street bifurcation
symbol in the upper left of the github window. You will be able to
choose which branch to work on, and to select master.</p>
<p>Let’s all try to stick to this protocol. It might seem a little
complicated at first, but you will quikly appreciate the fact that other
people’s mistakes won’t be able to endanger your working code, and that
by following the commits of the master branch alone, you will realize if
an update is incompatible with your work.</p>
<section id="first-steps">
<h2>4) First steps<a class="headerlink" href="#first-steps" title="Link to this heading">¶</a></h2>
<p>If the installation went well, you should now be able to load the
package in python. If that works you can pass directly to the next
section ‘Connecting to the RedPitaya’.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedPitaya</span>
</pre></div>
</div>
<p>Sometimes, python has problems finding the path to pyrplockbox. In that
case you should add the pyrplockbox directory to your pythonpath
environment variable
(<a class="reference external" href="http://stackoverflow.com/questions/3402168/permanently-add-a-directory-to-pythonpath">http://stackoverflow.com/questions/3402168/permanently-add-a-directory-to-pythonpath</a>).
If you do not know how to do that, just manually navigate the ipython
console to the directory, for example:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">c</span><span class="p">:</span>\<span class="n">lneuhaus</span>\<span class="n">github</span>\<span class="n">pyrpl</span>
</pre></div>
</div>
<p>Now retry to load the module. It should really work now.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedPitaya</span>
</pre></div>
</div>
<section id="connecting-to-the-redpitaya">
<h3>Connecting to the RedPitaya<a class="headerlink" href="#connecting-to-the-redpitaya" title="Link to this heading">¶</a></h3>
<p>You should have a working SD card (any version of the SD card content is
okay) in your RedPitaya (for instructions see
<a class="reference external" href="http://redpitaya.com/quick-start/">http://redpitaya.com/quick-start/</a>). The RedPitaya should be connected
via ethernet to your computer. To set this up, there is plenty of
instructions on the RedPitaya website
(<a class="reference external" href="http://redpitaya.com/quick-start/">http://redpitaya.com/quick-start/</a>). If you type the ip address of your
module in a browser, you should be able to start the different apps from
the manufacturer. The default address is <a class="reference external" href="http://192.168.1.100">http://192.168.1.100</a>. If this
works, we can load the python interface of pyrplockbox by specifying the
RedPitaya’s ip address.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HOSTNAME</span> <span class="o">=</span> <span class="s2">&quot;192.168.1.100&quot;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedPitaya</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">RedPitaya</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">HOSTNAME</span><span class="p">)</span>
</pre></div>
</div>
<p>If you see at least one ‘&gt;’ symbol, your computer has successfully
connected to your RedPitaya via SSH. This means that your connection
works. The message ‘Server application started on port 2222’ means that
your computer has sucessfully installed and started a server application
on your RedPitaya. Once you get ‘Client started with success’, your
python session has successfully connected to that server and all things
are in place to get started.</p>
</section>
<section id="basic-communication-with-your-redpitaya">
<h3>Basic communication with your RedPitaya<a class="headerlink" href="#basic-communication-with-your-redpitaya" title="Link to this heading">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#check the value of input1</span>
<span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">voltage1</span>
</pre></div>
</div>
<p>With the last command, you have successfully retrieved a value from an
FPGA register. This operation takes about 300 µs on my computer. So
there is enough time to repeat the reading n times.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#see how the adc reading fluctuates over time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">times</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="p">[],[]</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">voltage1</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Rough time to read one FPGA register: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="s2">&quot;µs&quot;</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">f</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">);</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ADC voltage vs time&quot;</span><span class="p">);</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">);</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ADC voltage histogram&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>You see that the input values are not exactly zero. This is normal with
all RedPitayas as some offsets are hard to keep zero when the
environment changes (temperature etc.). So we will have to compensate
for the offsets with our software. Another thing is that you see quite a
bit of scatter beetween the points - almost as much that you do not see
that the datapoints are quantized. The conclusion here is that the input
noise is typically not totally negligible. Therefore we will need to use
every trick at hand to get optimal noise performance.</p>
<p>After reading from the RedPitaya, let’s now try to write to the register
controlling the first 8 yellow LED’s on the board. The number written to
the LED register is displayed on the LED array in binary representation.
You should see some fast flashing of the yellow leds for a few seconds
when you execute the next block.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#blink some leds for 5 seconds</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1025</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">hk</span><span class="o">.</span><span class="n">led</span><span class="o">=</span><span class="n">i</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.005</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now feel free to play around a little to get familiar with binary representation by looking at the leds.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
<span class="n">r</span><span class="o">.</span><span class="n">hk</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="mb">0b00000001</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">hk</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="o">~</span><span class="n">r</span><span class="o">.</span><span class="n">hk</span><span class="o">.</span><span class="n">led</span><span class="o">&gt;&gt;</span><span class="mi">1</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">hk</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="redpitaya-modules">
<h2>5) RedPitaya modules<a class="headerlink" href="#redpitaya-modules" title="Link to this heading">¶</a></h2>
<p>Let’s now look a bit closer at the class RedPitaya. Besides managing the
communication with your board, it contains different modules that
represent the different sections of the FPGA. You already encountered
two of them in the example above: “hk” and “scope”. Here is the full
list of modules:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">hk</span> <span class="c1">#&quot;housekeeping&quot; = LEDs and digital inputs/outputs</span>
<span class="n">r</span><span class="o">.</span><span class="n">ams</span> <span class="c1">#&quot;analog mixed signals&quot; = auxiliary ADCs and DACs.</span>

<span class="n">r</span><span class="o">.</span><span class="n">scope</span> <span class="c1">#oscilloscope interface</span>

<span class="n">r</span><span class="o">.</span><span class="n">asg1</span> <span class="c1">#&quot;arbitrary signal generator&quot; channel 1</span>
<span class="n">r</span><span class="o">.</span><span class="n">asg2</span> <span class="c1">#&quot;arbitrary signal generator&quot; channel 2</span>

<span class="n">r</span><span class="o">.</span><span class="n">pid0</span> <span class="c1">#first of four PID modules</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid1</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid2</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid3</span>

<span class="n">r</span><span class="o">.</span><span class="n">iq0</span> <span class="c1">#first of three I+Q quadrature demodulation/modulation modules</span>
<span class="n">r</span><span class="o">.</span><span class="n">iq1</span>
<span class="n">r</span><span class="o">.</span><span class="n">iq2</span>

<span class="n">r</span><span class="o">.</span><span class="n">iir</span> <span class="c1">#&quot;infinite impules response&quot; filter module that can realize complex transfer functions</span>
</pre></div>
</div>
<section id="asg-and-scope-module">
<h3>ASG and Scope module<a class="headerlink" href="#asg-and-scope-module" title="Link to this heading">¶</a></h3>
</section>
<section id="arbitrary-signal-generator">
<h3>Arbitrary Signal Generator<a class="headerlink" href="#arbitrary-signal-generator" title="Link to this heading">¶</a></h3>
<p>There are two Arbitrary Signal Generator modules: asg1 and asg2. For
these modules, any waveform composed of <span class="math notranslate nohighlight">\(2^{14}\)</span> programmable
points is sent to the output with arbitrary frequency and start phase
upon a trigger event.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asg</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asg1</span> <span class="c1"># make a shortcut</span>
<span class="nb">print</span> <span class="s2">&quot;Trigger sources:&quot;</span><span class="p">,</span> <span class="n">asg</span><span class="o">.</span><span class="n">trigger_sources</span>
<span class="nb">print</span> <span class="s2">&quot;Output options: &quot;</span><span class="p">,</span> <span class="n">asg</span><span class="o">.</span><span class="n">output_directs</span>
</pre></div>
</div>
<p>Let’s set up the ASG to output a sawtooth signal of amplitude 0.8 V
(peak-to-peak 1.6 V) at 1 MHz on output 2:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asg</span><span class="o">.</span><span class="n">output_direct</span> <span class="o">=</span> <span class="s1">&#39;out2&#39;</span>
<span class="n">asg</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">waveform</span><span class="o">=</span><span class="s1">&#39;halframp&#39;</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="mf">20e4</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trigger_source</span><span class="o">=</span><span class="s1">&#39;immediately&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="oscilloscope">
<h3>Oscilloscope<a class="headerlink" href="#oscilloscope" title="Link to this heading">¶</a></h3>
<p>The scope works similar to the ASG but in reverse: Two channels are
available. A table of <span class="math notranslate nohighlight">\(2^{14}\)</span> datapoints for each channel is
filled with the time series of incoming data. Downloading a full trace
takes about 10 ms over standard ethernet. The rate at which the memory
is filled is the sampling rate (125 MHz) divided by the value of
‘decimation’. The property ‘average’ decides whether each datapoint is a
single sample or the average of all samples over the decimation
interval.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">scope</span> <span class="c1"># shortcut</span>
<span class="nb">print</span> <span class="s2">&quot;Available decimation factors:&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">decimations</span>
<span class="nb">print</span> <span class="s2">&quot;Trigger sources:&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">trigger_sources</span>
<span class="nb">print</span> <span class="s2">&quot;Available inputs: &quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">inputs</span>
</pre></div>
</div>
<p>Let’s have a look at a signal generated by asg1. Later we will use
convenience functions to reduce the amount of code necessary to set up
the scope:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedPitaya</span>

<span class="c1">#reload everything</span>
<span class="c1">#r = RedPitaya(hostname=&quot;192.168.1.100&quot;)</span>
<span class="n">asg</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asg1</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">scope</span>

<span class="c1"># turn off asg so the scope has a chance to measure its &quot;off-state&quot; as well</span>
<span class="n">asg</span><span class="o">.</span><span class="n">output_direct</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span>

<span class="c1"># setup scope</span>
<span class="n">s</span><span class="o">.</span><span class="n">input1</span> <span class="o">=</span> <span class="s1">&#39;asg1&#39;</span>

<span class="c1"># pass asg signal through pid0 with a simple integrator - just for fun (detailed explanations for pid will follow)</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;asg1&#39;</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># reset the integrator to zero</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># unity gain frequency of 1000 hz</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># proportional gain of 1.0</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># leave input filter disabled for now</span>

<span class="c1"># show pid output on channel2</span>
<span class="n">s</span><span class="o">.</span><span class="n">input2</span> <span class="o">=</span> <span class="s1">&#39;pid0&#39;</span>

<span class="c1"># trig at zero volt crossing</span>
<span class="n">s</span><span class="o">.</span><span class="n">threshold_ch1</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># positive/negative slope is detected by waiting for input to</span>
<span class="c1"># sweept through hysteresis around the trigger threshold in</span>
<span class="c1"># the right direction</span>
<span class="n">s</span><span class="o">.</span><span class="n">hysteresis_ch1</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="c1"># trigger on the input signal positive slope</span>
<span class="n">s</span><span class="o">.</span><span class="n">trigger_source</span> <span class="o">=</span> <span class="s1">&#39;ch1_positive_edge&#39;</span>

<span class="c1"># take data symetrically around the trigger event</span>
<span class="n">s</span><span class="o">.</span><span class="n">trigger_delay</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># set decimation factor to 64 -&gt; full scope trace is 8ns * 2^14 * decimation = 8.3 ms long</span>
<span class="n">s</span><span class="o">.</span><span class="n">decimation</span> <span class="o">=</span> <span class="mi">64</span>

<span class="c1"># setup the scope for an acquisition</span>
<span class="n">s</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Before turning on asg:&quot;</span>
<span class="nb">print</span> <span class="s2">&quot;Curve ready:&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">curve_ready</span><span class="p">()</span> <span class="c1"># trigger should still be armed</span>

<span class="c1"># turn on asg and leave enough time for the scope to record the data</span>
<span class="n">asg</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">start_phase</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">waveform</span><span class="o">=</span><span class="s1">&#39;halframp&#39;</span><span class="p">,</span> <span class="n">trigger_source</span><span class="o">=</span><span class="s1">&#39;immediately&#39;</span><span class="p">)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">0.010</span><span class="p">)</span>

<span class="c1"># check that the trigger has been disarmed</span>
<span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">After turning on asg:&quot;</span>
<span class="nb">print</span> <span class="s2">&quot;Curve ready:&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">curve_ready</span><span class="p">()</span>
<span class="nb">print</span> <span class="s2">&quot;Trigger event age [ms]:&quot;</span><span class="p">,</span><span class="mf">8e-9</span><span class="o">*</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">current_timestamp</span><span class="o">&amp;</span><span class="mh">0xFFFFFFFFFFFFFFFF</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">trigger_timestamp</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>

<span class="c1"># plot the data</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">times</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">curve</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">s</span><span class="o">.</span><span class="n">times</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">curve</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">2</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time [ms]&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Voltage&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>What do we see? The blue trace for channel 1 shows just the output
signal of the asg. The time=0 corresponds to the trigger event. One can
see that the trigger was not activated by the constant signal of 0 at
the beginning, since it did not cross the hysteresis interval. One can
also see a ‘bug’: After setting up the asg, it outputs the first value
of its data table until its waveform output is triggered. For the
halframp signal, as it is implemented in pyrpl, this is the maximally
negative value. However, we passed the argument start_phase=90 to the
asg.setup function, which shifts the first point by a quarter period.
Can you guess what happens when we set start_phase=180? You should try
it out!</p>
<p>In green, we see the same signal, filtered through the pid module. The
nonzero proportional gain leads to instant jumps along with the asg
signal. The integrator is responsible for the constant decrease rate at
the beginning, and the low-pass that smoothens the asg waveform a
little. One can also foresee that, if we are not paying attention, too
large an integrator gain will quickly saturate the outputs.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># useful functions for scope diagnostics</span>
<span class="nb">print</span> <span class="s2">&quot;Curve ready:&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">curve_ready</span><span class="p">()</span>
<span class="nb">print</span> <span class="s2">&quot;Trigger source:&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">trigger_source</span>
<span class="nb">print</span> <span class="s2">&quot;Trigger threshold [V]:&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">threshold_ch1</span>
<span class="nb">print</span> <span class="s2">&quot;Averaging:&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">average</span>
<span class="nb">print</span> <span class="s2">&quot;Trigger delay [s]:&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">trigger_delay</span>
<span class="nb">print</span> <span class="s2">&quot;Trace duration [s]: &quot;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">duration</span>
<span class="nb">print</span> <span class="s2">&quot;Trigger hysteresis [V]&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">hysteresis_ch1</span>
<span class="nb">print</span> <span class="s2">&quot;Current scope time [cycles]:&quot;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Trigger time [cycles]:&quot;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">trigger_timestamp</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Current voltage on channel 1 [V]:&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">voltage1</span>
<span class="nb">print</span> <span class="s2">&quot;First point in data buffer 1 [V]:&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">ch1_firstpoint</span>
</pre></div>
</div>
</section>
<section id="pid-module">
<h3>PID module<a class="headerlink" href="#pid-module" title="Link to this heading">¶</a></h3>
<p>We have already seen some use of the pid module above. There are four
PID modules available: pid0 to pid3.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">help</span><span class="p">()</span>
</pre></div>
</div>
<section id="proportional-and-integral-gain">
<h4>Proportional and integral gain<a class="headerlink" href="#proportional-and-integral-gain" title="Link to this heading">¶</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#make shortcut</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span>

<span class="c1">#turn off by setting gains to zero</span>
<span class="n">pid</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="nb">print</span> <span class="s2">&quot;P/I gain when turned off:&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">pid</span><span class="o">.</span><span class="n">p</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># small nonzero numbers set gain to minimum value - avoids rounding off to zero gain</span>
<span class="n">pid</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mf">1e-100</span>
<span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mf">1e-100</span>
<span class="nb">print</span> <span class="s2">&quot;Minimum proportional gain: &quot;</span><span class="p">,</span><span class="n">pid</span><span class="o">.</span><span class="n">p</span>
<span class="nb">print</span> <span class="s2">&quot;Minimum integral unity-gain frequency [Hz]: &quot;</span><span class="p">,</span><span class="n">pid</span><span class="o">.</span><span class="n">i</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># saturation at maximum values</span>
<span class="n">pid</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mf">1e100</span>
<span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mf">1e100</span>
<span class="nb">print</span> <span class="s2">&quot;Maximum proportional gain: &quot;</span><span class="p">,</span><span class="n">pid</span><span class="o">.</span><span class="n">p</span>
<span class="nb">print</span> <span class="s2">&quot;Maximum integral unity-gain frequency [Hz]: &quot;</span><span class="p">,</span><span class="n">pid</span><span class="o">.</span><span class="n">i</span>
</pre></div>
</div>
</section>
<section id="control-with-the-integral-value-register">
<h4>Control with the integral value register<a class="headerlink" href="#control-with-the-integral-value-register" title="Link to this heading">¶</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="c1">#make shortcut</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span>

<span class="c1"># set input to asg1</span>
<span class="n">pid</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s2">&quot;asg1&quot;</span>

<span class="c1"># set asg to constant 0.1 Volts</span>
<span class="n">r</span><span class="o">.</span><span class="n">asg1</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">waveform</span><span class="o">=</span><span class="s2">&quot;DC&quot;</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># set scope ch1 to pid0</span>
<span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">input1</span> <span class="o">=</span> <span class="s1">&#39;pid0&#39;</span>

<span class="c1">#turn off the gains for now</span>
<span class="n">pid</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

<span class="c1">#set integral value to zero</span>
<span class="n">pid</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">#prepare data recording</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="n">times</span><span class="p">,</span> <span class="n">ivals</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="c1"># turn on integrator to whatever negative gain</span>
<span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

<span class="c1"># set integral value above the maximum positive voltage</span>
<span class="n">pid</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="mf">1.5</span>

<span class="c1">#take 1000 points - jitter of the ethernet delay will add a noise here but we dont care</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
    <span class="n">ivals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="o">.</span><span class="n">ival</span><span class="p">)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">voltage1</span><span class="p">)</span>

<span class="c1">#plot</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span><span class="n">ivals</span><span class="p">,</span><span class="n">times</span><span class="p">,</span><span class="n">outputs</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Voltage&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Again, what do we see? We set up the pid module with a constant
(positive) input from the ASG. We then turned on the integrator (with
negative gain), which will inevitably lead to a slow drift of the output
towards negative voltages (blue trace). We had set the integral value
above the positive saturation voltage, such that it takes longer until
it reaches the negative saturation voltage. The output of the pid module
is bound to saturate at +- 1 Volts, which is clearly visible in the
green trace. The value of the integral is internally represented by a 32
bit number, so it can practically take arbitrarily large values compared
to the 14 bit output. You can set it within the range from +4 to -4V,
for example if you want to exloit the delay, or even if you want to
compensate it with proportional gain.</p>
</section>
<section id="input-filters">
<h4>Input filters<a class="headerlink" href="#input-filters" title="Link to this heading">¶</a></h4>
<p>The pid module has one more feature: A bank of 4 input filters in
series. These filters can be either off (bandwidth=0), lowpass
(bandwidth positive) or highpass (bandwidth negative). The way these
filters were implemented demands that the filter bandwidths can only
take values that scale as the powers of 2.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># off by default</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># minimum cutoff frequency is 2 Hz, maximum 77 kHz (for now)</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mf">1e10</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mf">1e10</span><span class="p">]</span>
<span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># not setting a coefficient turns that filter off</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
<span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setting without list also works</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2000</span>
<span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># turn off again</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">inputfilter</span>
</pre></div>
</div>
<p>You should now go back to the Scope and ASG example above and play
around with the setting of these filters to convince yourself that they
do what they are supposed to.</p>
</section>
</section>
<section id="iq-module">
<h3>IQ module<a class="headerlink" href="#iq-module" title="Link to this heading">¶</a></h3>
<p>Demodulation of a signal means convolving it with a sine and cosine at
the ‘carrier frequency’. The two resulting signals are usually low-pass
filtered and called ‘quadrature I’ and ‘quadrature Q’. Based on this
simple idea, the IQ module of pyrpl can implement several
functionalities, depending on the particular setting of the various
registers. In most cases, the configuration can be completely carried
out through the setup function of the module.</p>
<p>Lock-in detection / PDH / synchronous detection</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#reload to make sure settings are default ones</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pyrpl</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">Pyrpl</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rp</span>

<span class="c1">#shortcut</span>
<span class="n">iq</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">iq0</span>

<span class="c1"># modulation/demodulation frequency 25 MHz</span>
<span class="c1"># two lowpass filters with 10 and 20 kHz bandwidth</span>
<span class="c1"># input signal is analog input 1</span>
<span class="c1"># input AC-coupled with cutoff frequency near 50 kHz</span>
<span class="c1"># modulation amplitude 0.1 V</span>
<span class="c1"># modulation goes to out1</span>
<span class="c1"># output_signal is the demodulated quadrature 1</span>
<span class="c1"># quadrature_1 is amplified by 10</span>
<span class="n">iq</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mf">25e6</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="p">[</span><span class="mf">10e3</span><span class="p">,</span><span class="mf">20e3</span><span class="p">],</span> <span class="n">gain</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
         <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">acbandwidth</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
         <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;adc1&#39;</span><span class="p">,</span> <span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;out1&#39;</span><span class="p">,</span>
         <span class="n">output_signal</span><span class="o">=</span><span class="s1">&#39;quadrature&#39;</span><span class="p">,</span> <span class="n">quadrature_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>After this setup, the demodulated quadrature is available as the
output_signal of iq0, and can serve for example as the input of a PID
module to stabilize the frequency of a laser to a reference cavity. The
module was tested and is in daily use in our lab. Frequencies as low as
20 Hz and as high as 50 MHz have been used for this technique. At the
present time, the functionality of a PDH-like detection as the one set
up above cannot be conveniently tested internally. We plan to upgrade
the IQ-module to VCO functionality in the near future, which will also
enable testing the PDH functionality.</p>
<section id="network-analyzer">
<h4>Network analyzer<a class="headerlink" href="#network-analyzer" title="Link to this heading">¶</a></h4>
<p>When implementing complex functionality in the RedPitaya, the network
analyzer module is by far the most useful tool for diagnostics. The
network analyzer is able to probe the transfer function of any other
module or external device by exciting the device with a sine of variable
frequency and analyzing the resulting output from that device. This is
done by demodulating the device output (=network analyzer input) with
the same sine that was used for the excitation and a corresponding
cosine, lowpass-filtering, and averaging the two quadratures for a
well-defined number of cycles. From the two quadratures, one can extract
the magnitude and phase shift of the device’s transfer function at the
probed frequencies. Let’s illustrate the behaviour. For this example,
you should connect output 1 to input 1 of your RedPitaya, such that we
can compare the analog transfer function to a reference. Make sure you
put a 50 Ohm terminator in parallel with input 1.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># shortcut for na</span>
<span class="n">na</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">na</span>
<span class="n">na</span><span class="o">.</span><span class="n">iq_name</span> <span class="o">=</span> <span class="s1">&#39;iq1&#39;</span>

<span class="c1">#take transfer functions. first: iq1 -&gt; iq1, second iq1-&gt;out1-&gt;(your cable)-&gt;adc1</span>
<span class="n">f</span><span class="p">,</span> <span class="n">iq1</span><span class="p">,</span> <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">na</span><span class="o">.</span><span class="n">curve</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="mf">62.5e6</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="mi">1001</span><span class="p">,</span><span class="n">rbw</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">avg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;iq1&#39;</span><span class="p">,</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">acbandwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f</span><span class="p">,</span> <span class="n">adc1</span><span class="p">,</span> <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">na</span><span class="o">.</span><span class="n">curve</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="mf">62.5e6</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="mi">1001</span><span class="p">,</span><span class="n">rbw</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">avg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;adc1&#39;</span><span class="p">,</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;out1&#39;</span><span class="p">,</span> <span class="n">acbandwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#plot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl.iir</span><span class="w"> </span><span class="kn">import</span> <span class="n">bodeplot</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">bodeplot</span><span class="p">([(</span><span class="n">f</span><span class="p">,</span> <span class="n">iq1</span><span class="p">,</span> <span class="s2">&quot;iq1-&gt;iq1&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">adc1</span><span class="p">,</span> <span class="s2">&quot;iq1-&gt;out1-&gt;in1-&gt;iq1&quot;</span><span class="p">)],</span> <span class="n">xlog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>If your cable is properly connected, you will see that both magnitudes
are near 0 dB over most of the frequency range. Near the Nyquist
frequency (62.5 MHz), one can see that the internal signal remains flat
while the analog signal is strongly attenuated, as it should be to avoid
aliasing. One can also see that the delay (phase lag) of the internal
signal is much less than the one through the analog signal path.</p>
<p>If you have executed the last example (PDH detection) in this python
session, iq0 should still send a modulation to out1, which is added to
the signal of the network analyzer, and sampled by input1. In this case,
you should see a little peak near the PDH modulation frequency, which
was 25 MHz in the example above.</p>
</section>
<section id="lorentzian-bandpass-filter">
<h4>Lorentzian bandpass filter<a class="headerlink" href="#lorentzian-bandpass-filter" title="Link to this heading">¶</a></h4>
<p>The iq module can also be used as a bandpass filter with continuously
tunable phase. Let’s measure the transfer function of such a bandpass
with the network analyzer:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># shortcut for na and bpf (bandpass filter)</span>
<span class="n">na</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">na</span>
<span class="n">na</span><span class="o">.</span><span class="n">iq_name</span> <span class="o">=</span> <span class="s1">&#39;iq1&#39;</span>
<span class="n">bpf</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">iq2</span>

<span class="c1"># setup bandpass</span>
<span class="n">bpf</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">frequency</span> <span class="o">=</span> <span class="mf">2.5e6</span><span class="p">,</span> <span class="c1">#center frequency</span>
          <span class="n">Q</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="c1"># the filter quality factor</span>
          <span class="n">acbandwidth</span> <span class="o">=</span> <span class="mf">10e5</span><span class="p">,</span> <span class="c1"># ac filter to remove pot. input offsets</span>
          <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># nominal phase at center frequency (propagation phase lags not accounted for)</span>
          <span class="n">gain</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="c1"># peak gain = +6 dB</span>
          <span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span>
          <span class="n">output_signal</span><span class="o">=</span><span class="s1">&#39;output_direct&#39;</span><span class="p">,</span>
          <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;iq1&#39;</span><span class="p">)</span>

<span class="c1"># take transfer function</span>
<span class="n">f</span><span class="p">,</span> <span class="n">tf1</span><span class="p">,</span> <span class="n">ampl</span> <span class="o">=</span> <span class="n">na</span><span class="o">.</span><span class="n">curve</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">4e6</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">rbw</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                     <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;iq2&#39;</span><span class="p">,</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1"># add a phase advance of 82.3 degrees and measure transfer function</span>
<span class="n">bpf</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mf">82.3</span>
<span class="n">f</span><span class="p">,</span> <span class="n">tf2</span><span class="p">,</span> <span class="n">ampl</span> <span class="o">=</span> <span class="n">na</span><span class="o">.</span><span class="n">curve</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">4e6</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">rbw</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                     <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;iq2&#39;</span><span class="p">,</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1">#plot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl.iir</span><span class="w"> </span><span class="kn">import</span> <span class="n">bodeplot</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">bodeplot</span><span class="p">([(</span><span class="n">f</span><span class="p">,</span> <span class="n">tf1</span><span class="p">,</span> <span class="s2">&quot;phase = 0.0&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tf2</span><span class="p">,</span> <span class="s2">&quot;phase = </span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="o">%</span><span class="k">bpf</span>.phase)])
</pre></div>
</div>
</section>
<section id="frequency-comparator-module">
<h4>Frequency comparator module<a class="headerlink" href="#frequency-comparator-module" title="Link to this heading">¶</a></h4>
<p>To lock the frequency of a VCO (Voltage controlled oscillator) to a
frequency reference defined by the RedPitaya, the IQ module contains the
frequency comparator block. This is how you set it up. You have to feed
the output of this module through a PID block to send it to the analog
output. As you will see, if your feedback is not already enabled when
you turn on the module, its integrator will rapidly saturate (-585 is
the maximum value here, while a value of the order of 1e-3 indicates a
reasonable frequency lock).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iq</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">iq0</span>

<span class="c1"># turn off pfd module for settings</span>
<span class="n">iq</span><span class="o">.</span><span class="n">pfd_on</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># local oscillator frequency</span>
<span class="n">iq</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="mf">33.7e6</span>

<span class="c1"># local oscillator phase</span>
<span class="n">iq</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">iq</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;adc1&#39;</span>
<span class="n">iq</span><span class="o">.</span><span class="n">output_direct</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span>
<span class="n">iq</span><span class="o">.</span><span class="n">output_signal</span> <span class="o">=</span> <span class="s1">&#39;pfd&#39;</span>

<span class="nb">print</span> <span class="s2">&quot;Before turning on:&quot;</span>
<span class="nb">print</span> <span class="s2">&quot;Frequency difference error integral&quot;</span><span class="p">,</span> <span class="n">iq</span><span class="o">.</span><span class="n">pfd_integral</span>

<span class="nb">print</span> <span class="s2">&quot;After turning on:&quot;</span>
<span class="n">iq</span><span class="o">.</span><span class="n">pfd_on</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Frequency difference error integral&quot;</span><span class="p">,</span> <span class="n">iq</span><span class="o">.</span><span class="n">pfd_integral</span>
</pre></div>
</div>
</section>
</section>
<section id="iir-module">
<h3>IIR module<a class="headerlink" href="#iir-module" title="Link to this heading">¶</a></h3>
<p>Sometimes it is interesting to realize even more complicated filters.
This is the case, for example, when a piezo resonance limits the maximum
gain of a feedback loop. For these situations, the IIR module can
implement filters with ‘Infinite Impulse Response’
(<a class="reference external" href="https://en.wikipedia.org/wiki/Infinite_impulse_response">https://en.wikipedia.org/wiki/Infinite_impulse_response</a>). It is the
your task to choose the filter to be implemented by specifying the
complex values of the poles and zeros of the filter. In the current
version of pyrpl, the IIR module can implement IIR filters with the
following properties: - strictly proper transfer function (number of
poles &gt; number of zeros) - poles (zeros) either real or
complex-conjugate pairs - no three or more identical real poles (zeros)
- no two or more identical pairs of complex conjugate poles (zeros) -
pole and zero frequencies should be larger than
<span class="math notranslate nohighlight">\(\frac{f_\rm{nyquist}}{1000}\)</span> (but you can optimize the nyquist
frequency of your filter by tuning the ‘loops’ parameter) - the DC-gain
of the filter must be 1.0. Despite the FPGA implemention being more
flexible, we found this constraint rather practical. If you need
different behavior, pass the IIR signal through a PID module and use its
input filter and proportional gain. If you still need different
behaviour, the file iir.py is a good starting point. - total filter
order &lt;= 16 (realizable with 8 parallel biquads) - a remaining bug
limits the dynamic range to about 30 dB before internal saturation
interferes with filter performance</p>
<p>Filters whose poles have a positive real part are unstable by design.
Zeros with positive real part lead to non-minimum phase lag.
Nevertheless, the IIR module will let you implement these filters.</p>
<p>In general the IIR module is still fragile in the sense that you should
verify the correct implementation of each filter you design. Usually you
can trust the simulated transfer function. It is nevertheless a good
idea to use the internal network analyzer module to actually measure the
IIR transfer function with an amplitude comparable to the signal you
expect to go through the filter, as to verify that no saturation of
internal filter signals limits its performance.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#reload to make sure settings are default ones</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedPitaya</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">RedPitaya</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>

<span class="c1">#shortcut</span>
<span class="n">iir</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">iir</span>

<span class="c1">#print docstring of the setup function</span>
<span class="nb">print</span> <span class="n">iir</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="vm">__doc__</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#prepare plot parameters</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="c1">#setup a complicated transfer function</span>
<span class="n">zeros</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mf">4e4j</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="o">+</span><span class="mf">4e4j</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span><span class="o">-</span><span class="mf">2e5j</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="o">+</span><span class="mf">2e5j</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mf">2e6j</span><span class="o">-</span><span class="mi">3000</span><span class="p">,</span> <span class="o">+</span><span class="mf">2e6j</span><span class="o">-</span><span class="mi">3000</span><span class="p">]</span>
<span class="n">poles</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mf">1e6</span><span class="p">,</span> <span class="o">-</span><span class="mf">5e4j</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="o">+</span><span class="mf">5e4j</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e5j</span><span class="o">-</span><span class="mi">3000</span><span class="p">,</span> <span class="o">+</span><span class="mf">1e5j</span><span class="o">-</span><span class="mi">3000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e6j</span><span class="o">-</span><span class="mi">30000</span><span class="p">,</span> <span class="o">+</span><span class="mf">1e6j</span><span class="o">-</span><span class="mi">30000</span><span class="p">]</span>
<span class="n">designdata</span> <span class="o">=</span> <span class="n">iir</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span> <span class="n">poles</span><span class="p">,</span> <span class="n">loops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="nb">print</span> <span class="s2">&quot;Filter sampling frequency: &quot;</span><span class="p">,</span> <span class="mf">125.</span><span class="o">/</span><span class="n">iir</span><span class="o">.</span><span class="n">loops</span><span class="p">,</span><span class="s2">&quot;MHz&quot;</span>
</pre></div>
</div>
<p>If you try changing a few coefficients, you will see that your design
filter is not always properly realized. The bottleneck here is the
conversion from the analytical expression (poles and zeros) to the
filter coefficients, not the FPGA performance. This conversion is (among
other things) limited by floating point precision. We hope to provide a
more robust algorithm in future versions. If you can obtain filter
coefficients by another, preferrably analytical method, this might lead
to better results than our generic algorithm.</p>
<p>Let’s check if the filter is really working as it is supposed:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first thing to check if the filter is not ok</span>
<span class="nb">print</span> <span class="s2">&quot;IIR overflows before:&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">iir</span><span class="o">.</span><span class="n">overflow</span><span class="p">)</span>

<span class="c1"># measure tf of iir filter</span>
<span class="n">r</span><span class="o">.</span><span class="n">iir</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;iq1&#39;</span>
<span class="n">f</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">ampl</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">curve</span><span class="p">(</span><span class="n">iq_name</span><span class="o">=</span><span class="s1">&#39;iq1&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">3e6</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="mi">301</span><span class="p">,</span> <span class="n">rbw</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;iir&#39;</span><span class="p">,</span> <span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">logscale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># first thing to check if the filter is not ok</span>
<span class="nb">print</span> <span class="s2">&quot;IIR overflows after:&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">iir</span><span class="o">.</span><span class="n">overflow</span><span class="p">)</span>

<span class="c1">#plot with design data</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl.iir</span><span class="w"> </span><span class="kn">import</span> <span class="n">bodeplot</span>
<span class="n">bodeplot</span><span class="p">(</span><span class="n">designdata</span> <span class="o">+</span><span class="p">[(</span><span class="n">f</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="s2">&quot;measured system&quot;</span><span class="p">)],</span><span class="n">xlog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>As you can see, the filter has trouble to realize large dynamic ranges.
With the current standard design software, it takes some ‘practice’ to
design transfer functions which are properly implemented by the code.
While most zeros are properly realized by the filter, you see that the
first two poles suffer from some kind of saturation. We are working on
an automatic rescaling of the coefficients to allow for optimum dynamic
range. From the overflow register printed above the plot, you can also
see that the network analyzer scan caused an internal overflow in the
filter. All these are signs that different parameters should be tried.</p>
<p>A straightforward way to impove filter performance is to adjust the
DC-gain and compensate it later with the gain of a subsequent PID
module. See for yourself what the parameter g=0.1 (instead of the
default value g=1.0) does here:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#rescale the filter by 20fold reduction of DC gain</span>
<span class="n">designdata</span> <span class="o">=</span> <span class="n">iir</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span><span class="n">poles</span><span class="p">,</span><span class="n">g</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">loops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

<span class="c1"># first thing to check if the filter is not ok</span>
<span class="nb">print</span> <span class="s2">&quot;IIR overflows before:&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">iir</span><span class="o">.</span><span class="n">overflow</span><span class="p">)</span>

<span class="c1"># measure tf of iir filter</span>
<span class="n">r</span><span class="o">.</span><span class="n">iir</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;iq1&#39;</span>
<span class="n">f</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">ampl</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">iq1</span><span class="o">.</span><span class="n">na_trace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">3e6</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="mi">301</span><span class="p">,</span> <span class="n">rbw</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;iir&#39;</span><span class="p">,</span> <span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">logscale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># first thing to check if the filter is not ok</span>
<span class="nb">print</span> <span class="s2">&quot;IIR overflows after:&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">iir</span><span class="o">.</span><span class="n">overflow</span><span class="p">)</span>

<span class="c1">#plot with design data</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">pylab</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl.iir</span><span class="w"> </span><span class="kn">import</span> <span class="n">bodeplot</span>
<span class="n">bodeplot</span><span class="p">(</span><span class="n">designdata</span><span class="o">+</span><span class="p">[(</span><span class="n">f</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="s2">&quot;measured system&quot;</span><span class="p">)],</span><span class="n">xlog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>You see that we have improved the second peak (and avoided internal
overflows) at the cost of increased nosie in other regions. Of course
this noise can be reduced by increasing the NA averaging time. But maybe
it will be detrimental to your application? After all, IIR filter design
is far from trivial, but this tutorial should have given you enough
information to get started and maybe to improve the way we have
implemented the filter in pyrpl (e.g. by implementing automated filter
coefficient scaling).</p>
<p>If you plan to play more with the filter, these are the remaining
internal iir registers:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iir</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">iir</span>

<span class="c1"># useful diagnostic functions</span>
<span class="nb">print</span> <span class="s2">&quot;IIR on:&quot;</span><span class="p">,</span> <span class="n">iir</span><span class="o">.</span><span class="n">on</span>
<span class="nb">print</span> <span class="s2">&quot;IIR bypassed:&quot;</span><span class="p">,</span> <span class="n">iir</span><span class="o">.</span><span class="n">shortcut</span>
<span class="nb">print</span> <span class="s2">&quot;IIR copydata:&quot;</span><span class="p">,</span> <span class="n">iir</span><span class="o">.</span><span class="n">copydata</span>
<span class="nb">print</span> <span class="s2">&quot;IIR loops:&quot;</span><span class="p">,</span> <span class="n">iir</span><span class="o">.</span><span class="n">loops</span>
<span class="nb">print</span> <span class="s2">&quot;IIR overflows:&quot;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">(</span><span class="n">iir</span><span class="o">.</span><span class="n">overflow</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coefficients (6 per biquad):&quot;</span>
<span class="nb">print</span> <span class="n">iir</span><span class="o">.</span><span class="n">coefficients</span>

<span class="c1"># set the unity transfer function to the filter</span>
<span class="n">iir</span><span class="o">.</span><span class="n">_setup_unity</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="the-pyrpl-class">
<h2>6) The Pyrpl class<a class="headerlink" href="#the-pyrpl-class" title="Link to this heading">¶</a></h2>
<p>The RedPitayas in our lab are mostly used to stabilize one item or
another in quantum optics experiments. To do so, the experimenter
usually does not want to bother with the detailed implementation on the
RedPitaya while trying to understand the physics going on in her/his
experiment. For this situation, we have developed the Pyrpl class, which
provides an API with high-level functions such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># optimial pdh-lock with setpoint 0.1 cavity bandwidth away from resonance</span>
<span class="n">cavity</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;pdh&#39;</span><span class="p">,</span><span class="n">detuning</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># unlock the cavity</span>
<span class="n">cavity</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>

<span class="c1"># calibrate the fringe height of an interferometer, and lock it at local oscillator phase 45 degrees</span>
<span class="n">interferometer</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">phase</span><span class="o">=</span><span class="mf">45.0</span><span class="p">)</span>
</pre></div>
</div>
<section id="first-attempts-at-locking">
<h3>First attempts at locking<a class="headerlink" href="#first-attempts-at-locking" title="Link to this heading">¶</a></h3>
<p>SECTION NOT READY YET, BECAUSE CODE NOT CLEANED YET</p>
<p>Now lets go for a first attempt to lock something. Say you connect the
error signal (transmission or reflection) of your setup to input 1. Make
sure that the peak-to-peak of the error signal coincides with the
maximum voltages the RedPitaya can handle (-1 to +1 V if the jumpers are
set to LV). This is important for getting optimal noise performance. If
your signal is too low, amplify it. If it is too high, you should build
a voltage divider with 2 resistors of the order of a few kOhm (that way,
the input impedance of the RedPitaya of 1 MOhm does not interfere).</p>
<p>Next, connect output 1 to the standard actuator at your hand, e.g. a
piezo. Again, you should try to exploit the full -1 to +1 V output
range. If the voltage at the actuator must be kept below 0.5V for
example, you should make another voltage divider for this. Make sure
that you take the input impedance of your actuator into consideration
here. If you output needs to be amplified, it is best practice to put
the voltage divider after the amplifier as to also attenuate the noise
added by the amplifier. Hovever, when this poses a problem (limited
bandwidth because of capacity of the actuator), you have to put the
voltage divider before the amplifier. Also, this is the moment when you
should think about low-pass filtering the actuator voltage. Because of
DAC noise, analog low-pass filters are usually more effective than
digital ones. A 3dB bandwidth of the order of 100 Hz is a good starting
point for most piezos.</p>
<p>You often need two actuators to control your cavity. This is because the
output resolution of 14 bits can only realize 16384 different values.
This would mean that with a finesse of 15000, you would only be able to
set it to resonance or a linewidth away from it, but nothing in between.
To solve this, use a coarse actuator to cover at least one free spectral
range which brings you near the resonance, and a fine one whose range is
1000 or 10000 times smaller and who gives you lots of graduation around
the resonance. The coarse actuator should be strongly low-pass filtered
(typical bandwidth of 1Hz or even less), the fine actuator can have 100
Hz or even higher bandwidth. Do not get confused here: the unity-gain
frequency of your final lock can be 10- or even 100-fold above the 3dB
bandwidth of the analog filter at the output - it suffices to increase
the proportional gain of the RedPitaya Lockbox.</p>
<p>Once everything is connected, let’s grab a PID module, make a shortcut
to it and print its helpstring. All modules have a metho help() which
prints all available registers and their description:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span>
<span class="nb">print</span> <span class="n">pid</span><span class="o">.</span><span class="n">help</span><span class="p">()</span>
<span class="n">pid</span><span class="o">.</span><span class="n">ival</span> <span class="c1">#bug: help forgets about pid.ival: current integrator value [volts]</span>
</pre></div>
</div>
<p>We need to inform our RedPitaya about which connections we want to make.
The cabling discussed above translates into:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pid</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;adc1&#39;</span>
<span class="n">pid</span><span class="o">.</span><span class="n">output_direct</span> <span class="o">=</span> <span class="s1">&#39;out1&#39;</span>

<span class="c1">#see other available options just for curiosity:</span>
<span class="nb">print</span> <span class="n">pid</span><span class="o">.</span><span class="n">inputs</span>
<span class="nb">print</span> <span class="n">pid</span><span class="o">.</span><span class="n">output_directs</span>
</pre></div>
</div>
<p>Finally, we need to define a setpoint. Lets first measure the offset
when the laser is away from the resonance, and then measure or estimate
how much light gets through on resonance.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># turn on the laser</span>
<span class="n">offresonant</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">voltage1</span> <span class="c1">#volts at analog input 1 with the unlocked cavity</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a guess of what voltage you will measure at an optical resonance</span>
<span class="n">resonant</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1">#Volts at analog input 1</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the setpoint at relative reflection of 0.75 / rel. transmission of 0.25</span>
<span class="n">pid</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">=</span> <span class="mf">0.75</span><span class="o">*</span><span class="n">offresonant</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">resonant</span>
</pre></div>
</div>
<p>Now lets start to approach the resonance. We need to figure out from
which side we are coming. The choice is made such that a simple
integrator will naturally drift into the resonance and stay there:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># make sure gain is off</span>
<span class="n">pid</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#errorsignal = adc1 - setpoint</span>
<span class="k">if</span> <span class="n">resonant</span> <span class="o">&gt;</span> <span class="n">offresonant</span><span class="p">:</span> <span class="c1"># when we are away from resonance, error is negative.</span>
    <span class="n">slopesign</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># therefore, near resonance, the slope is positive as the error crosses zero.</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">slopesign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">gainsign</span> <span class="o">=</span> <span class="o">-</span><span class="n">slopesign</span> <span class="c1">#the gain must be the opposite to stabilize</span>
<span class="c1"># the effectove gain will in any case slopesign*gainsign = -1.</span>

<span class="c1">#Therefore we must start at the maximum positive voltage, so the negative effective gain leads to a decreasing output</span>
<span class="n">pid</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1">#sets the integrator value = output voltage to maximum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1">#wait for the voltage to stabilize (adjust for a few times the lowpass filter bandwidth)</span>

<span class="c1">#finally, turn on the integrator</span>
<span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">gainsign</span> <span class="o">*</span> <span class="mf">0.1</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#with a bit of luck, this should work</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">relative_error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">voltage1</span><span class="o">-</span><span class="n">pid</span><span class="o">.</span><span class="n">setpoint</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">offresonant</span><span class="o">-</span><span class="n">resonant</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1">#diagnostics every 2 seconds</span>
        <span class="nb">print</span> <span class="s2">&quot;relative error:&quot;</span><span class="p">,</span><span class="n">relative_error</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">relative_error</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pid</span><span class="o">.</span><span class="n">ival</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Resonance missed. Trying again slower..&quot;</span>
        <span class="n">pid</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="c1">#overshoot a little</span>
        <span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">/=</span> <span class="mi">2</span>
<span class="nb">print</span> <span class="s2">&quot;Resonance approch successful&quot;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Questions to users: what parameters do you know?
finesse of the cavity? 1000
length? 1.57m
what error signals are available? transmission direct, reflection AC -&gt; directement pdh analogique

are modulators available n/a

what cavity length / laser frequency actuators are available? PZT mephisto DC - 10kHz, 48MHz opt./V, V_rp apmplifie x20
temperature du laser &lt;1 Hz 2.5~GHz/V, apres AOM

what is known about them (displacement, bandwidth, amplifiers)?

what analog filters are present? YAG PZT a 10kHz

imposer le design des sorties
</pre></div>
</div>
<p>More to come</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedPitaya</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">RedPitaya</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>

<span class="c1">#shortcut</span>
<span class="n">iq</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">iq0</span>

<span class="n">iq</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mf">1000e3</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="p">[</span><span class="mf">10e3</span><span class="p">,</span><span class="mf">20e3</span><span class="p">],</span> <span class="n">gain</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
         <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">acbandwidth</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
         <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;adc1&#39;</span><span class="p">,</span> <span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;out1&#39;</span><span class="p">,</span>
         <span class="n">output_signal</span><span class="o">=</span><span class="s1">&#39;output_direct&#39;</span><span class="p">,</span> <span class="n">quadrature_factor</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">iq</span><span class="o">.</span><span class="n">frequency</span><span class="o">=</span><span class="mi">10</span>
<span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">input1</span><span class="o">=</span><span class="s1">&#39;adc1&#39;</span>

<span class="c1"># shortcut for na</span>
<span class="n">na</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">na</span>
<span class="n">na</span><span class="o">.</span><span class="n">iq_name</span> <span class="o">=</span> <span class="s2">&quot;iq1&quot;</span>

<span class="c1"># pid1 will be our device under test</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">pid0</span>
<span class="n">pid</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;iq1&#39;</span>
<span class="n">pid</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">pid</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">pid</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">pid</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">pid</span><span class="o">.</span><span class="n">inputfilter</span> <span class="o">=</span> <span class="p">[]</span><span class="c1">#[-1e3, 5e3, 20e3, 80e3]</span>

<span class="c1"># take the transfer function through pid1, this will take a few seconds...</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ampl</span> <span class="o">=</span> <span class="n">na</span><span class="o">.</span><span class="n">curve</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="mf">200e3</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span><span class="n">rbw</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">avg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;iq1&#39;</span><span class="p">,</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">acbandwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#plot</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency [kHz]&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;|S21|&quot;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;iq1&#39;</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span>
<span class="n">r</span><span class="o">.</span><span class="n">iq2</span><span class="o">.</span><span class="n">input</span><span class="o">=</span><span class="s1">&#39;iq1&#39;</span>
<span class="n">r</span><span class="o">.</span><span class="n">iq2</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bandwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">gain</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">acbandwidth</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">amplitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;iq1&#39;</span><span class="p">,</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;out1&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">p</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">na</span><span class="o">.</span><span class="n">na_trace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span><span class="n">rbw</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">avg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;adc1&#39;</span><span class="p">,</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">acbandwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">iq2</span><span class="o">.</span><span class="n">frequency</span><span class="o">=</span><span class="mf">1e6</span>
<span class="n">r</span><span class="o">.</span><span class="n">iq2</span><span class="o">.</span><span class="n">_reads</span><span class="p">(</span><span class="mh">0x140</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">iq2</span><span class="o">.</span><span class="n">_na_averages</span><span class="o">=</span><span class="mi">125000000</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">iq0</span><span class="o">.</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;off&#39;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">input2</span><span class="o">=</span><span class="s1">&#39;dac2&#39;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">iq0</span><span class="o">.</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">0.5</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">iq0</span><span class="o">.</span><span class="n">amplitude</span>
</pre></div>
</div>
</section>
</section>
<section id="the-graphical-user-interface">
<h2>7) The Graphical User Interface<a class="headerlink" href="#the-graphical-user-interface" title="Link to this heading">¶</a></h2>
<p>Most of the modules described in section 5 can be controlled via a
graphical user interface. The graphical window can be displayed with the
following:</p>
<p>WARNING: For the GUI to work fine within an ipython session, the option
–gui=qt has to be given to the command launching ipython. This makes
sure that an event loop is running.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make sure the notebook was launched with the following option:</span>
<span class="c1"># ipython notebook --pylab=qt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl.gui</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedPitayaGui</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">RedPitayaGui</span><span class="p">(</span><span class="n">HOSTNAME</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">gui</span><span class="p">()</span>
</pre></div>
</div>
<p>The following window should open itself. Feel free to play with the
button and tabs to start and stop the scope acquisition…</p>
<p>The window is composed of several tabs, each corresponding to a
particular module. Since they generate a graphical output, the scope,
network analyzer, and spectrum analyzer modules are very pleasant to use
in GUI mode. For instance, the scope tab can be used to display in
real-time the waveforms acquired by the redpitaya scope. Since the
refresh rate is quite good, the scope tab can be used to perform optical
alignements or to monitor transient signals as one would do it with a
standalone scope.</p>
<p>Subclassing RedPitayaGui to customize the GUI</p>
<p>It is often convenient to develop a GUI that relies heavily on the
existing RedPitayaGui, but with a few more buttons or functionalities.
In this case, the most convenient solution is to derive the RedPitayaGui
class. The GUI is programmed using the framework PyQt4. The full
documentation of the framework can be found here:
<a class="reference external" href="http://pyqt.sourceforge.net/Docs/PyQt4/">http://pyqt.sourceforge.net/Docs/PyQt4/</a>. However, to quickly start in
the right direction, a simple example of how to customize the gui is
given below: The following code shows how to add a few buttons at the
bottom of the scope tab to switch the experiment between the two states:
Scanning with asg1/Locking with pid1</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl.gui</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedPitayaGui</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt4</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RedPitayaGuiCustom</span><span class="p">(</span><span class="n">RedPitayaGui</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the derived class containing our customizations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">customize_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#This function is called upon object instanciation</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        By overwritting this function in the child class, the user can perform custom initializations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">layout_custom</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="c1">#Adds an horizontal layout for our extra-buttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_scan</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Scan&quot;</span><span class="p">)</span>
        <span class="c1"># creates a button &quot;Scan&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_lock</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Lock&quot;</span><span class="p">)</span>
        <span class="c1"># creates a button &quot;Lock&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">label_setpoint</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Setpoint&quot;</span><span class="p">)</span>
        <span class="c1"># creates a label for the setpoint spinbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">spinbox_setpoint</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QDoubleSpinBox</span><span class="p">()</span>
        <span class="c1"># creates a spinbox to enter the value of the setpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">spinbox_setpoint</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="c1"># sets the desired number of decimals for the spinbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">spinbox_setpoint</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="c1"># Change the step by which the setpoint is incremented when using the arrows</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">layout_custom</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_scan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">layout_custom</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_lock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">layout_custom</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">label_setpoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">layout_custom</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">spinbox_setpoint</span><span class="p">)</span>
        <span class="c1"># Adds the buttons in the layout</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">layout_custom</span><span class="p">)</span>
        <span class="c1"># Adds the layout at the bottom of the scope layout</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_scan</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_lock</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">spinbox_setpoint</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">change_setpoint</span><span class="p">)</span>
        <span class="c1"># connects the buttons to the desired functions</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">custom_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#This function is also called upon object instanciation</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        By overwritting this function in the child class, the user can perform custom initializations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#setup asg1 to output the desired ramp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asg1</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mf">.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asg1</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asg1</span><span class="o">.</span><span class="n">waveform</span> <span class="o">=</span> <span class="s2">&quot;ramp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asg1</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asg1</span><span class="o">.</span><span class="n">trigger_source</span> <span class="o">=</span> <span class="s1">&#39;immediately&#39;</span>

        <span class="c1">#setup the scope to record approximately one period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">input1</span> <span class="o">=</span> <span class="s1">&#39;dac1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">input2</span> <span class="o">=</span> <span class="s1">&#39;dac2&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">trigger_source</span> <span class="o">=</span> <span class="s1">&#39;asg1&#39;</span>

        <span class="c1">#automatically start the scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">run_continuous</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">change_setpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Directly reflects the value of the spinbox into the pid0 setpoint</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">spinbox_setpoint</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#Called when button lock is clicked</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up everything in &quot;lock mode&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># disable button lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_lock</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># enable button scan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_scan</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>


        <span class="c1"># shut down the asg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asg1</span><span class="o">.</span><span class="n">output_direct</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span>

        <span class="c1"># set pid input/outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;adc1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">output_direct</span> <span class="o">=</span> <span class="s1">&#39;out2&#39;</span>

        <span class="c1">#set pid parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">spinbox_setpoint</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#Called when button lock is clicked</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up everything in &quot;scan mode&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># enable button lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_lock</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># enable button scan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_widget</span><span class="o">.</span><span class="n">button_scan</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># switch asg on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asg1</span><span class="o">.</span><span class="n">output_direct</span> <span class="o">=</span> <span class="s1">&#39;out2&#39;</span>

        <span class="c1">#switch pid off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid0</span><span class="o">.</span><span class="n">output_direct</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span>

<span class="c1"># Instantiate the class RePitayaGuiCustom</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">RedPitayaGuiCustom</span><span class="p">(</span><span class="n">HOSTNAME</span><span class="p">)</span>
<span class="c1"># launch the gui</span>
<span class="n">r</span><span class="o">.</span><span class="n">gui</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, a custom gui with several extra buttons at the bottom of the scope
tab should open itself. You can play with the buttons “scan” and “Lock”
and see the effect on the channels.</p>
</section>
<section id="using-asynchronous-functions-with-python-3">
<h2>8) Using asynchronous functions with python 3<a class="headerlink" href="#using-asynchronous-functions-with-python-3" title="Link to this heading">¶</a></h2>
<p>Pyrpl uses the Qt eventloop to perform asynchronous tasks, but it has
been set as the default loop of <code class="docutils literal notranslate"><span class="pre">asyncio</span></code>, such that you only need to
learn how to use the standard python module
<code class="docutils literal notranslate"><span class="pre">`asyncio</span></code> &lt;<a class="reference external" href="https://docs.python.org/3/library/asyncio.html">https://docs.python.org/3/library/asyncio.html</a>&gt;`__, and
you don’t need to know anything about Qt. To give you a quick overview
of what can be done, we present in the following block an exemple of 2
tasks running in parrallele. The first one mimicks a temperature control
loop, measuring periodically a signal every 1 s, and changing the offset
of an <code class="docutils literal notranslate"><span class="pre">asg</span></code> based on the measured value (we realize this way a slow
and rudimentary software pid). In parrallele, another task consists in
repeatedly shifting the frequency of an asg, and measuring an averaged
spectrum on the spectrum analyzer.</p>
<p>Both tasks are defined by coroutines (a python function that is preceded
by the keyword <code class="docutils literal notranslate"><span class="pre">async</span></code>, and that can contain the keyword <code class="docutils literal notranslate"><span class="pre">await</span></code>).
Basically, the execution of each coroutine is interrupted whenever the
keyword <code class="docutils literal notranslate"><span class="pre">await</span></code> is encountered, giving the chance to other tasks to be
executed. It will only be resumed once the underlying coroutine’s value
becomes ready.</p>
<p>Finally to execute the cocroutines, it is not enough to call
<code class="docutils literal notranslate"><span class="pre">my_coroutine()</span></code>, since we need to send the task to the event loop.
For that, we use the function <code class="docutils literal notranslate"><span class="pre">ensure_future</span></code> from the asyncio module.
This function immediately returns an object that is not the result of
the task (not the object that is behind <code class="docutils literal notranslate"><span class="pre">return</span></code> inside the
coroutine), but rather a Future object, that can be used to retrieve the
actual result once it is ready (this is done by calling
<code class="docutils literal notranslate"><span class="pre">future.result()</span></code> latter on).</p>
<p>If you are executing the code inside the ipython notebook, then, this is
all you have to do, since an event loop is already running in the back
(a qt eventloop if you are using the option %pylab qt). Otherwise, you
have to use one of the functions (<code class="docutils literal notranslate"><span class="pre">LOOP.run_forever()</span></code>,
<code class="docutils literal notranslate"><span class="pre">LOOP.run_until_complete()</span></code>, or <code class="docutils literal notranslate"><span class="pre">LOOP.run_in_executor()</span></code>) to launch
the eventloop.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pylab</span> qt
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrpl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pyrpl</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Pyrpl</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="c1"># we have to do something about the notebook initializations...</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_temperature_lock</span><span class="p">(</span><span class="n">setpoint</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>  <span class="c1"># coroutines can receive arguments</span>
    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">asgs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">asg</span><span class="p">:</span> <span class="c1">#  use the context manager &quot;with&quot; to</span>
    <span class="c1"># make sure the asg will be freed after the acquisition</span>
        <span class="n">asg</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">amplitue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#  Use the asg as a dummy</span>
        <span class="k">while</span> <span class="n">IS_TEMP_LOCK_ACTIVE</span><span class="p">:</span> <span class="c1">#  The loop will run untill this flag is manually changed to False</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#  Give way to other coroutines for 1 s</span>
                <span class="n">measured_temp</span> <span class="o">=</span> <span class="n">asg</span><span class="o">.</span><span class="n">offset</span> <span class="c1">#  Dummy &quot;temperature&quot; measurment</span>
                <span class="n">asg</span><span class="o">.</span><span class="n">offset</span><span class="o">+=</span> <span class="p">(</span><span class="n">setpoint</span> <span class="o">-</span> <span class="n">measured_temp</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>  <span class="c1">#  feedback with an integral gain</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;measured temp: &quot;</span><span class="p">,</span> <span class="n">measured_temp</span><span class="p">)</span> <span class="c1">#  print the measured value to see how the execution flow works</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_n_fits</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="c1">#  a coroutine to launch n acquisitions</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">spectrumanalyzer</span>
    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">asgs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fit_spectra&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">asg</span><span class="p">:</span> <span class="c1"># use contextmanager again</span>
        <span class="n">asg</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">output_direct</span><span class="o">=</span><span class="s1">&#39;out1&#39;</span><span class="p">,</span>
                  <span class="n">trigger_source</span><span class="o">=</span><span class="s1">&#39;immediately&#39;</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#  variables stay available all along the coroutine&#39;s execution</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="c1">#  The coroutine qill be executed several times on the await statement inside this loop</span>
            <span class="n">asg</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mi">1000</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="c1">#  Move the asg frequency</span>
            <span class="n">sa</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">asg</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="mf">100e3</span><span class="p">,</span> <span class="n">baseband</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#  setup the sa for the acquisition</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sa</span><span class="o">.</span><span class="n">single_async</span><span class="p">()</span> <span class="c1">#  wait for 10 averages to be ready</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">data_x</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span> <span class="c1">#  take the max of the spectrum</span>
            <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="c1">#  append it ti the result</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;measured peak frequency: &quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="c1">#  print to show how the execution goes</span>
        <span class="k">return</span> <span class="n">freqs</span> <span class="c1">#  Once the execution is over, the Future will be filled with the result...</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">ensure_future</span><span class="p">,</span> <span class="n">get_event_loop</span>
<span class="n">IS_TEMP_LOCK_ACTIVE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">temp_future</span> <span class="o">=</span> <span class="n">ensure_future</span><span class="p">(</span><span class="n">run_temperature_lock</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span> <span class="c1"># send temperature control task to the eventloop</span>
<span class="n">fits_future</span> <span class="o">=</span> <span class="n">ensure_future</span><span class="p">(</span><span class="n">run_n_fits</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span> <span class="c1"># send spectrum measurement task to the eventloop</span>

<span class="c1">## add the following lines if you don&#39;t already have an event_loop configured in ipython</span>
<span class="c1">#  LOOP = get_event_loop()</span>
<span class="c1">#  LOOP.run_until_complete()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Populating</span> <span class="n">the</span> <span class="n">interactive</span> <span class="n">namespace</span> <span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span> <span class="ow">and</span> <span class="n">matplotlib</span>
</pre></div>
</div>
<pre class="literal-block"><a class="reference external" href="INFO:pyrpl.redpitaya:">INFO:pyrpl.redpitaya:</a>&gt;
<a class="reference external" href="INFO:pyrpl.redpitaya:">INFO:pyrpl.redpitaya:</a>&gt;
<a class="reference external" href="INFO:pyrpl.redpitaya:">INFO:pyrpl.redpitaya:</a>&gt;
<a class="reference external" href="INFO:pyrpl.redpitaya:Server">INFO:pyrpl.redpitaya:Server</a> application started on port 2222
<a class="reference external" href="INFO:pyrpl.modules:Filter">INFO:pyrpl.modules:Filter</a> sampling frequency is 25. MHz
<a class="reference external" href="INFO:pyrpl.modules:IIR">INFO:pyrpl.modules:IIR</a> anti-aliasing input filter set to: 0.0 MHz
<a class="reference external" href="INFO:pyrpl.modules:IIR">INFO:pyrpl.modules:IIR</a> filter ready
C:UsersSamuelDocumentsGitHubpyrplpyrplhardware_modulesiiriir.py:262: RuntimeWarning: invalid value encountered in double_scalars
  reldev = maxdev / abs(self.iirfilter.coefficients.flatten()[np.argmax(dev)])
INFO:pyrpl.modules:Maximum deviation from design coefficients: 0 (relative: nan)
INFO:pyrpl.modules:IIR Overflow pattern: 0b0
INFO:pyrpl.redpitaya:Client started successfully.
INFO:pyrpl.redpitaya:Successfully connected to Redpitaya with hostname 10.214.1.28.
INFO:pyrpl.modules:Filter sampling frequency is 25. MHz
INFO:pyrpl.modules:IIR anti-aliasing input filter set to: 0.0 MHz
INFO:pyrpl.modules:IIR filter ready
INFO:pyrpl.modules:Maximum deviation from design coefficients: 0 (relative: nan)
INFO:pyrpl.modules:IIR Overflow pattern: 0b0
WARNING:pyrpl.modules:Trying to load attribute amplitue of module asg1 that are invalid setup_attributes.</pre>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.0</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">0.0</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.0499267578125</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.0948486328125</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">998.871152907</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.13525390625</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.171630859375</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">1997.74230581</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.2044677734375</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.2340087890625</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">2996.61345872</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.260498046875</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.284423828125</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">4002.93887396</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.305908203125</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.3253173828125</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">5001.81002687</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.3427734375</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.3583984375</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">6000.68117978</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.37255859375</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.38525390625</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">6999.55233268</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.396728515625</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.406982421875</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">7998.42348559</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.416259765625</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">8997.2946385</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.424560546875</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.4320068359375</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">10003.6200537</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.438720703125</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.44482421875</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">11002.4912066</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.4503173828125</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.4552001953125</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IS_TEMP_LOCK_ACTIVE</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#  hint, you can stop the spectrum acquisition task by pressin &quot;pause or stop in the</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fits_future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">InvalidStateError</span>                         <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">731</span><span class="n">b5bc52817</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
      <span class="mi">1</span> <span class="n">IS_TEMP_LOCK_ACTIVE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="o">----&gt;</span> <span class="mi">2</span> <span class="nb">print</span><span class="p">(</span><span class="n">fits_future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>


<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Samuel</span>\<span class="n">Anaconda3</span>\<span class="n">lib</span>\<span class="n">asyncio</span>\<span class="n">futures</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">result</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">285</span>             <span class="k">raise</span> <span class="n">CancelledError</span>
    <span class="mi">286</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">_FINISHED</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">287</span>             <span class="k">raise</span> <span class="n">InvalidStateError</span><span class="p">(</span><span class="s1">&#39;Result is not ready.&#39;</span><span class="p">)</span>
    <span class="mi">288</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_log_traceback</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="mi">289</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tb_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>


<span class="n">InvalidStateError</span><span class="p">:</span> <span class="n">Result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ready</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">12001.3623596</span>
<span class="n">measured</span> <span class="n">temp</span><span class="p">:</span>  <span class="mf">0.4595947265625</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">13000.2335125</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">13999.1046654</span>
<span class="n">measured</span> <span class="n">peak</span> <span class="n">frequency</span><span class="p">:</span>  <span class="mf">14997.9758183</span>
</pre></div>
</div>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/user_guide/tutorial/tutorial.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2014-2025, Leonhard Neuhaus, Samuel Deléglise, Michaël Croquette .<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.4.7.<br/>
    </p>
  </div>
</footer>
  </body>
</html>